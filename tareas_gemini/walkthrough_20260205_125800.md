# Walkthrough - Pull-to-Refresh on Home Screen

We have implemented the ability for users to manually refresh their home feed by pulling down on the article list.

## Changes Made

### 1. Home BLoC Optimization

Updated `HomeBloc` to handle reloads more gracefully. When a refresh is triggered while the screen is already showing data, it now emits a background loading state (`isLoading: true`) instead of a full-screen loading state. This prevents the entire screen from going blank during a manual refresh.

```diff
   Future<void> _onLoadHomeData(
     LoadHomeData event,
     Emitter<HomeState> emit,
   ) async {
     final currentState = state;
-    emit(HomeLoading()); // Muestra el indicador de carga.
+
+    // Use a background loading state if we are already loaded
+    if (currentState is HomeLoaded) {
+      emit(currentState.copyWith(isLoading: true));
+    } else {
+      emit(HomeLoading()); // Full screen loader for initial load
+    }
```

### 2. UI Integration

Wrapped the `ListView` in `ArticleListWidget` with a `RefreshIndicator`. This widget provides the native Android/iOS pull-to-refresh behavior.

```dart
return RefreshIndicator(
  onRefresh: () async {
    // Dispatch LoadHomeData event
    homeBloc.add(LoadHomeData(
      forceReload: true,
      // ... metadata
    ));

    // Wait for the background work to complete
    await homeBloc.stream.firstWhere((state) => state is! HomeLoaded || !state.isLoading);
  },
  child: ListView.builder(...),
);
```

### 3. User List Fix

Solved the issue where the user list would get stuck in a loading state after a manual refresh. This was caused by the BLoC not emitting a new state when data hadn't changed, leaving the UI's `firstWhere` stream listener waiting indefinitely.

- **State**: Added `isLoading` to `UserListLoaded`.
- **BLoC**: `_onRefreshUsers` now emits a background loading state.
- **UI**: Corrected the `onRefresh` logic to wait for the `isLoading: false` signal and added `AlwaysScrollableScrollPhysics` for better UX on short lists.

### 4. Association List Refresh

Implemented the pull-to-refresh functionality in the Association List, allowing administrators to manually update the list of cooperatives.

- **State**: Added `isLoading` flag to `AssociationsLoaded` to track background refreshes.
- **BLoC**: Added `RefreshAssociations` event and handler to perform non-blocking reloads.
- **UI**: Integrated `RefreshIndicator` in `AssociationListPage` and configured `AlwaysScrollableScrollPhysics` to ensure the gesture is available even with few items.

### 5. Role-Based Access Control (RBAC) Security

Implemented refined security rules to ensure articles are edited only by authorized users.

- **Superadmin**: Full access to edit any article (association-specific or general).
- **Admin**: Can edit any article belonging to their association.
- **Editor**: Restricted to editing only their _own_ articles within their association.
- **Generales**: Articles without an association (general) can only be edited by Superadmins.
- **Enforcement**: Applied checks in `ArticleCardWidget` (UI visibility) and `ArticleEditBloc` (logic protection).

### 6. Fix: Last Login Date Update

Resolved an issue where the `lastLoginDate` field in Firestore was not updating when users logged in via the standard email flow.

- **Logic**: Added a Firestore update call to `signInWithEmailOnly` within `AuthRemoteDataSourceImpl`.
- **Field**: Uses `FieldValue.serverTimestamp()` for consistency.

### 7. Superadmin UI and Logic Fixes

Addressed several issues specific to the Superadmin role to ensure a smooth experience when managing content globally.

- **Association Label**: Fixed a bug where the AppBar would briefly show "Asociaci√≥n desconocida" on app restart. This was caused by the system attempting to use an internal permission flag (`superadmin_access`) as a real association.
- **Article Creation**: Relaxed the requirement for a selected association when a Superadmin creates a new article, allowing for the creation of "General" articles (with empty association ID).
- **Stability**: Improved the labeling logic in `HomePageViewWidget` to ensure "Todas" remains the stable default for Superadmins not scoped to a specific cooperative.

## Verification Results

### Manual Test (Home Screen)

- [x] Pull-down gesture successfully triggers the refresh spinner.
- [x] The spinner disappears only after the BLoC completes the data fetch.
- [x] The list remains visible during the refresh (no full-screen flickering).
- [x] Fresh data is correctly fetched from the database.

### Manual Test (User List)

- [x] Pull-to-refresh no longer gets stuck when data is identical.
- [x] "Bad state: No element" crash is resolved.
- [x] Refresh works correctly even with few users in the list.

### Manual Test (Association List)

- [x] Pull-down successfully triggers the refresh spinner.
- [x] The list updates without clearing the screen during the load.
- [x] Spinner correctly dismisses upon completion.

### Manual Test (RBAC Security)

- [x] Superadmin sees the edit button on all articles.
- [x] Admin sees the edit button on all articles of their association.
- [x] Editor only sees the edit button on articles they created.
- [x] Edit button is hidden for general articles when logged in as Admin/Editor.
- [x] Direct access to edit page via URL/Navigator is blocked for unauthorized users by the BLoC.

### Manual Test (User Profile)

- [x] `lastLoginDate` in Firestore updates automatically after the next login.

### Manual Test (Superadmin)

- [x] AppBar consistently shows "Todas" (or the specific association if selected) on restart.
- [x] "Unknown Association" label no longer appears.
- [x] Superadmin can successfully open the "Create Article" page and save general articles.
