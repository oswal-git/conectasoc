rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================
    // HELPER FUNCTIONS
    // =========================================
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isSuperAdmin() {
      return isSignedIn() && 
             'memberships' in getUserData() &&
             getUserData().memberships.get('superadmin_access', '') == 'superadmin';
    }
    
    function isAdmin(associationId) {
      return isSignedIn() && 
             'memberships' in getUserData() &&
             getUserData().memberships.get(associationId, '') == 'admin';
    }  

    function isEditor(associationId) {
      return isSignedIn() && 
             'memberships' in getUserData() &&
             getUserData().memberships.get(associationId, '') == 'editor';
    }
    
    function isMemberOf(associationId) {
      return isSignedIn() &&
             'memberships' in getUserData() &&
             associationId in getUserData().memberships;
    }

    // =========================================
    // COLECCIÓN: users
    // =========================================
    match /users/{userId} {
      
      // IMPORTANTE: Permite contar usuarios para "isFirstUser"
      // Considera mover esto a una Cloud Function por seguridad
      allow list: if true;
      
      // Crear: usuario autenticado crea su propio documento
      allow create: if isSignedIn() && request.auth.uid == userId;
      
      // Leer: propio usuario, superadmin, o admin de asociación donde es miembro
      allow read: if isSignedIn() && (
        request.auth.uid == userId ||
        isSuperAdmin()
        // Admins pueden ver usuarios de su asociación - requiere query constraint
      );
      
      // Actualizar:
      // 1. Usuario solo puede actualizar campos de perfil
      // 2. Superadmin puede actualizar todo
      // 3. Admins pueden actualizar usuarios de su asociación (sin crear superadmins)
      allow update: if isSignedIn() && (
        (request.auth.uid == userId && 
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['firstName', 'lastName', 'phone', 'language', 'avatarUrl', 'dateUpdated'])) ||
        isSuperAdmin() ||
        (
          // Admin puede modificar si el usuario tiene membresía en su asociación
          getUserData().memberships.keys().hasAny(resource.data.memberships.keys()) &&
          getUserData().memberships.keys().exists(k, getUserData().memberships[k] == 'admin') &&
          // No puede crear superadmins
          !request.resource.data.memberships.keys().hasAny(['superadmin_access'])
        )
      );
      
      allow delete: if isSuperAdmin();
    }
    
    // =========================================
    // COLECCIÓN: associations
    // =========================================
    match /associations/{associationId} {
      allow read, list: if true;
      
      allow create: if isSignedIn() && (
        request.resource.data.creatorId == request.auth.uid || 
        isSuperAdmin()
      );

      allow update: if isSuperAdmin() || isAdmin(associationId);
      allow delete: if isSuperAdmin();
    }

    // =========================================
    // COLECCIÓN: articles
    // =========================================
    match /articles/{articleId} {
      
      function isPublicArticle() {
        return resource.data.status == 'publicado';
      }

      // Leer:
      // 1. CUALQUIERA (autenticado o no) puede leer artículos públicos que sean genéricos (sin asociación).
      // 2. Los usuarios autenticados pueden leer artículos públicos de sus asociaciones.
      // 3. Los superadmins pueden leer todo.
      allow read, list: if (isPublicArticle() && resource.data.assocId == '') ||
                          (isSignedIn() && isPublicArticle() && isMemberOf(resource.data.assocId)) ||
                          isSuperAdmin();

      // Crear: debe tener rol apropiado Y pertenecer a la asociación
      allow create: if isSignedIn() && 
                      request.resource.data.userId == request.auth.uid && (
        isSuperAdmin() ||
        (
          (isAdmin(request.resource.data.assocId) || 
           isEditor(request.resource.data.assocId)) &&
          isValidArticleData(request.resource.data)
        )
      );

      function isValidArticleData(data) {
        return 
          // Campos requeridos
          data.keys().hasAll([
            'title', 'abstractContent', 'coverUrl', 'categoryId', 'subcategoryId', 
            'publishDate', 'effectiveDate', 'status', 'sections', 'userId', 
            'assocId', 'authorName', 'associationShortName', 'originalLanguage', 
            'createdAt', 'modifiedAt', 'searchText'
          ]) &&
          // Validación de tipos
          data.title is string && data.title.size() > 0 &&
          data.abstractContent is string && data.abstractContent.size() > 0 &&
          data.coverUrl is string && data.coverUrl.size() > 0 &&
          data.categoryId is string && data.categoryId.size() > 0 &&
          data.subcategoryId is string && data.subcategoryId.size() > 0 &&
          data.publishDate is timestamp &&
          data.effectiveDate is timestamp &&
          data.status is string &&
          data.sections is list &&
          data.userId is string && data.userId == request.auth.uid &&
          data.assocId is string &&
          data.authorName is string &&
          data.associationShortName is string &&
          data.originalLanguage is string &&
          data.createdAt is timestamp &&
          data.modifiedAt is timestamp &&
          data.searchText is string &&
          // Usuario debe ser miembro de la asociación del artículo
          (data.assocId == '' || data.assocId in getUserData().memberships) &&
          // Validación de fechas (opcional - puede estar en cliente)
          (data.expirationDate == null || data.expirationDate is timestamp);
      }

      // Actualizar: superadmin, admin de asociación, o editor-autor
      allow update: if isSignedIn() && (
        isSuperAdmin() || 
        (
          (isAdmin(resource.data.assocId) || 
           (isEditor(resource.data.assocId) && 
            request.auth.uid == resource.data.userId)) &&
          isValidArticleData(request.resource.data) &&
          request.resource.data.userId == resource.data.userId // No cambiar autor
        )
      );

      allow delete: if isSignedIn() && (
        isSuperAdmin() ||
        isAdmin(resource.data.assocId)
      );
    }
    
    // =========================================
    // COLECCIÓN: itemArticles
    // =========================================
    match /itemArticles/{itemId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        getUserData().memberships.values().hasAny(['admin', 'editor'])
      );
    }
    
    // =========================================
    // COLECCIÓN: categories & subcategories
    // =========================================
    match /categories/{categoryId} {
      allow read, list: if true;
      allow write: if isSuperAdmin();
    }

    match /subcategories/{subcategoryId} {
      allow read, list: if true;
      allow write: if isSuperAdmin();
    }

    // =========================================
    // COLECCIÓN: images
    // =========================================
    match /images/{imageId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (
        isSuperAdmin() ||
        getUserData().memberships.values().hasAny(['admin', 'editor'])
      );
    }
    
    // =========================================
    // COLECCIÓN: notifications
    // =========================================
    match /notifications/{notificationId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && (
        isSuperAdmin() ||
        getUserData().memberships.values().hasAny(['admin', 'editor'])
      );
      allow update, delete: if isSuperAdmin();
    }
    
    // =========================================
    // COLECCIÓN: notificationUsers
    // =========================================
    match /notificationUsers/{notificationUserId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        isSuperAdmin()
      );
      
      allow create: if isSignedIn();
      
      // Usuario puede marcar sus notificaciones como leídas
      allow update: if isSignedIn() && 
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['read', 'readAt']);
      
      allow delete: if isSuperAdmin();
    }
  }
}